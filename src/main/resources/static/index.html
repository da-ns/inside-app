<!DOCTYPE html>
<html class="h-100">
<head>
    <meta charset="UTF-8" />
    <title>Inside24 Task</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
          crossorigin="anonymous">

    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/jquery.cookie.js"></script>

    <script type="application/javascript">
        function login() {
            showLoader();

            var data = JSON.stringify({
                login: $("#login").val(),
                password: $("#password").val()
            });

            $.ajax({
              type: "POST",
              url: "/user/login",
              data: data,
              dataType: "json",
              contentType : "application/json"
            })
            .done(function(data) {
                if (data.token) {
                    $.cookie('jwt', data.token, { expires: 7, samesite: "Strict" });
                    showMessagePanel();
                } else {
                    showLoginPanel("User not found.");
                }
            })
            .fail(function(jqXHR, textStatus, errorThrown) {
                console.error("Error on server. " + errorThrown);
                showLoginPanel();
            });
        }

        function sendMessage() {
            showLoader();

            var token = $.cookie("jwt");

            var data = JSON.stringify({
                login: "login",
                text: $("#text").val()
            });

            $.ajax({
                type: "POST",
                url: "/message/create",
                data: data,
                dataType: "json",
                contentType : "application/json",
                beforeSend: function (xhr) {   //Include the bearer token in header
                  xhr.setRequestHeader("Authorization", 'Bearer '+ jwt);
                }
            })
            .done(function(data) {
                if (data.token) {
                    $.cookie('jwt', data.token, { expires: 7, samesite: "Strict" });
                    showMessagePanel();
                } else {
                    showLoginPanel("User not found.");
                }
            })
            .fail(function(jqXHR, textStatus, errorThrown) {
                console.error("Error on server. " + errorThrown);
                showLoginPanel();
            });
        }

        function loadHistory() {
            alert("loadHistory");
        }

        function showLoginPanel(message) {
            $("#loader").addClass("d-none");
            $("#messagePanel").addClass("d-none");
            $("#loginPanel").removeClass("d-none");
            $("#loginButton").click(login);
            $("#message").addClass("d-none");

            if (message) {
                $("#message").removeClass("d-none");
                $("#message div").text(message);
            }
        }

        function showMessagePanel() {
            $("#loader").addClass("d-none");
            $("#messagePanel").removeClass("d-none");
            $("#loginPanel").addClass("d-none");
            $("#message").addClass("d-none");
            $("#sendMessageButton").click(sendMessage);
            $("#loadHistoryButton").click(loadHistory);
        }

        function showLoader() {
            $("#loader").removeClass("d-none");
            $("#messagePanel").addClass("d-none");
            $("#loginPanel").addClass("d-none");
            $("#message").addClass("d-none");
        }

        $(document).ready(function() {
            var token = $.cookie("jwt");

            if (token) {
                showMessagePanel();
                return;
            }

            showLoginPanel()
        });
    </script>
</head>
<body class="h-100 d-flex justify-content-center">
    <div class="d-flex justify-content-center align-items-center flex-column">
        <div id="loader" class="spinner-border text-primary" role="status">
            <span class="sr-only"></span>
        </div>

        <div id="message" class="d-none w-100">
            <div class="alert alert-danger" role="alert"></div>
        </div>

        <div id="loginPanel" class="d-none">
            <div class="input-group mb-3">
                <input type="text" id="login" class="form-control"
                       placeholder="Login" aria-label="Login">
            </div>
            <div class="input-group mb-3">
                <input type="password" id="password" class="form-control"
                       placeholder="Password" aria-label="Password">
            </div>
            <div class="input-group mb-3 d-flex flex-row-reverse">
                <button id="loginButton" type="button" class="btn btn-primary">Login</button>
            </div>
        </div>

        <div id="messagePanel" class="d-none">
            <div class="input-group mb-3">
                <textarea id="text" class="form-control" rows="5" cols="50"
                          placeholder="Your message"></textarea>
            </div>
            <div class="input-group mb-3">
                <button id="sendMessageButton" type="button" class="btn btn-primary w-50">Send message</button>
                <button id="loadHistoryButton" type="button" class="btn btn-secondary w-50">Load history</button>
            </div>
            <div id="historyPanel" class="mb-3 w-100 d-none">
                <div class="alert alert-secondary" role="alert">

                </div>
            </div>
        </div>
    </div>
</body>
</html>